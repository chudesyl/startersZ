<!DOCTYPE html>
<html>
<head>
    <title>Payment Flow Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        .step { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #f0f8f0; border-color: #4ade80; }
        .error { background: #fdf2f2; border-color: #ef4444; }
        .info { background: #f0f4ff; border-color: #3b82f6; }
        .warning { background: #fff8f0; border-color: #f59e0b; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 5px; font-size: 14px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .test-results { margin-top: 20px; }
        .flow-step { padding: 10px; margin: 10px 0; border-left: 4px solid #ddd; }
        .flow-step.active { border-left-color: #3b82f6; background: #f0f4ff; }
        .flow-step.success { border-left-color: #10b981; background: #f0f8f0; }
        .flow-step.error { border-left-color: #ef4444; background: #fdf2f2; }
        .reference-display { font-family: monospace; background: #f3f4f6; padding: 8px; border-radius: 4px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîß Payment Flow Debug Tool</h1>
            <p>This tool tests the complete payment flow from initialization to verification to identify where the "Transaction reference not found" error occurs.</p>
        </div>

        <div class="card">
            <h2>üéØ Complete Payment Flow Test</h2>
            <button class="btn-primary" onclick="runCompleteFlow()">üöÄ Run Complete Payment Flow Test</button>
            <button class="btn-warning" onclick="testExistingReference()">üîç Test Existing Reference</button>
            <button class="btn-success" onclick="testCredentials()">üîë Test Credentials Only</button>
            <div id="flowResults"></div>
        </div>

        <div class="card">
            <h2>üìä Step-by-Step Analysis</h2>
            <div id="stepAnalysis"></div>
        </div>

        <div class="card">
            <h2>üîß Advanced Debugging</h2>
            <button class="btn-warning" onclick="testDirectPaystackAPI()">üåê Test Direct Paystack API</button>
            <button class="btn-primary" onclick="checkPaystackConfig()">‚öôÔ∏è Check Configuration</button>
            <div id="advancedResults"></div>
        </div>
    </div>

    <script>
        let flowData = {};

        async function runCompleteFlow() {
            const resultDiv = document.getElementById('flowResults');
            const stepDiv = document.getElementById('stepAnalysis');
            
            resultDiv.innerHTML = '<div class="info">üîÑ Running complete payment flow test...</div>';
            stepDiv.innerHTML = '';
            
            flowData = { steps: [], startTime: Date.now() };

            try {
                // Step 1: Test credentials
                await testStep('credentials', 'Testing Paystack credentials', async () => {
                    const response = await fetch('/functions/v1/paystack-debug', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'check_key_health' })
                    });
                    const data = await response.json();
                    if (!data.success || !data.health_check?.key_configured) {
                        throw new Error('Credentials not properly configured');
                    }
                    return data.health_check;
                });

                // Step 2: Initialize payment
                const initResult = await testStep('initialize', 'Initializing payment transaction', async () => {
                    const testPayload = {
                        action: 'initialize',
                        email: 'debug@test.com',
                        amount: 100000, // 1000 NGN
                        currency: 'NGN',
                        metadata: {
                            order_id: 'debug_order_' + Date.now(),
                            customer_name: 'Debug User'
                        },
                        callback_url: window.location.origin + '/payment/callback'
                    };
                    
                    const response = await fetch('/functions/v1/paystack-secure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testPayload)
                    });
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Payment initialization failed');
                    }
                    
                    flowData.paymentReference = data.data?.reference;
                    flowData.authorizationUrl = data.data?.authorization_url;
                    
                    return data.data;
                });

                // Step 3: Verify the payment reference exists
                if (flowData.paymentReference) {
                    await testStep('verify', 'Verifying payment reference exists', async () => {
                        const response = await fetch('/functions/v1/paystack-secure', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'verify',
                                reference: flowData.paymentReference
                            })
                        });
                        
                        const data = await response.json();
                        
                        // Note: This will likely fail since payment isn't actually completed
                        // But it will show us if the reference exists in Paystack
                        return { 
                            response_received: true,
                            data: data,
                            reference_exists: data.success !== false || !data.error?.includes('not found')
                        };
                    });
                }

                // Step 4: Test callback simulation
                if (flowData.paymentReference) {
                    await testStep('callback', 'Testing callback verification', async () => {
                        const response = await fetch(`/payment/callback?reference=${flowData.paymentReference}&test=true`, {
                            method: 'GET'
                        });
                        
                        return {
                            status: response.status,
                            callback_tested: true,
                            url_tested: `/payment/callback?reference=${flowData.paymentReference}`
                        };
                    });
                }

                showFlowResults();

            } catch (error) {
                resultDiv.innerHTML += `<div class="error">‚ùå Flow test failed: ${error.message}</div>`;
                showFlowResults();
            }
        }

        async function testStep(stepId, description, testFunc) {
            const stepDiv = document.getElementById('stepAnalysis');
            const stepElement = document.createElement('div');
            stepElement.className = 'flow-step active';
            stepElement.id = `step_${stepId}`;
            stepElement.innerHTML = `
                <h4>üîÑ ${description}</h4>
                <p>Running...</p>
            `;
            stepDiv.appendChild(stepElement);

            const stepData = {
                id: stepId,
                description,
                startTime: Date.now(),
                status: 'running'
            };

            try {
                const result = await testFunc();
                stepData.endTime = Date.now();
                stepData.duration = stepData.endTime - stepData.startTime;
                stepData.status = 'success';
                stepData.result = result;

                stepElement.className = 'flow-step success';
                stepElement.innerHTML = `
                    <h4>‚úÖ ${description}</h4>
                    <p><strong>Duration:</strong> ${stepData.duration}ms</p>
                    <details>
                        <summary>Result Data</summary>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </details>
                `;

                flowData.steps.push(stepData);
                return result;

            } catch (error) {
                stepData.endTime = Date.now();
                stepData.duration = stepData.endTime - stepData.startTime;
                stepData.status = 'error';
                stepData.error = error.message;

                stepElement.className = 'flow-step error';
                stepElement.innerHTML = `
                    <h4>‚ùå ${description}</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Duration:</strong> ${stepData.duration}ms</p>
                `;

                flowData.steps.push(stepData);
                throw error;
            }
        }

        function showFlowResults() {
            const resultDiv = document.getElementById('flowResults');
            
            let html = '<div class="test-results">';
            html += '<h3>üîç Flow Analysis Results</h3>';
            
            if (flowData.paymentReference) {
                html += `
                    <div class="info">
                        <h4>üí≥ Payment Reference Generated</h4>
                        <div class="reference-display">${flowData.paymentReference}</div>
                        <p><strong>Key Analysis:</strong></p>
                        <ul>
                            <li>Format: ${flowData.paymentReference.startsWith('txn_') ? '‚úÖ Correct (txn_)' : '‚ö†Ô∏è Unexpected format'}</li>
                            <li>Length: ${flowData.paymentReference.length} characters</li>
                            <li>Timestamp: ${flowData.paymentReference.includes('_') ? '‚úÖ Contains timestamp' : '‚ùå No timestamp'}</li>
                        </ul>
                    </div>
                `;
            }

            // Show step summary
            const successSteps = flowData.steps.filter(s => s.status === 'success').length;
            const totalSteps = flowData.steps.length;
            
            html += `
                <div class="${successSteps === totalSteps ? 'success' : 'warning'}">
                    <h4>üìä Step Summary</h4>
                    <p><strong>Completed:</strong> ${successSteps}/${totalSteps} steps</p>
                    <p><strong>Total Time:</strong> ${Date.now() - flowData.startTime}ms</p>
                </div>
            `;

            // Analysis and recommendations
            html += '<div class="info"><h4>üîß Analysis & Recommendations</h4>';
            
            if (successSteps === 0) {
                html += '<p>‚ùå <strong>Issue:</strong> Payment initialization failed. Check your Paystack credentials.</p>';
            } else if (successSteps === 1) {
                html += '<p>‚ö†Ô∏è <strong>Issue:</strong> Credentials work but payment initialization fails. Check your Paystack account.</p>';
            } else if (successSteps === 2) {
                html += '<p>üîÑ <strong>Partial Success:</strong> Payment initialized but verification shows issues.</p>';
                html += '<p>üí° <strong>Next Step:</strong> Complete a real payment to test the full flow.</p>';
            } else {
                html += '<p>‚úÖ <strong>Success:</strong> Payment flow is working correctly!</p>';
            }

            html += '</div></div>';
            
            resultDiv.innerHTML = html;
        }

        async function testExistingReference() {
            const reference = prompt('Enter a payment reference to test:');
            if (!reference) return;

            const resultDiv = document.getElementById('flowResults');
            resultDiv.innerHTML = `<div class="info">üîç Testing reference: ${reference}</div>`;

            try {
                const response = await fetch('/functions/v1/paystack-secure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verify',
                        reference: reference
                    })
                });

                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="${data.success ? 'success' : 'error'}">
                        <h3>üîç Reference Test Result</h3>
                        <div class="reference-display">${reference}</div>
                        <p><strong>Status:</strong> ${data.success ? '‚úÖ Found' : '‚ùå Not Found'}</p>
                        <details>
                            <summary>Full Response</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error testing reference: ${error.message}</div>`;
            }
        }

        async function testCredentials() {
            const resultDiv = document.getElementById('flowResults');
            resultDiv.innerHTML = '<div class="info">üîë Testing credentials...</div>';

            try {
                const response = await fetch('/functions/v1/paystack-debug', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'check_key_health' })
                });

                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="${data.success ? 'success' : 'error'}">
                        <h3>üîë Credential Test Result</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error testing credentials: ${error.message}</div>`;
            }
        }

        async function testDirectPaystackAPI() {
            const resultDiv = document.getElementById('advancedResults');
            resultDiv.innerHTML = '<div class="info">üåê Testing direct Paystack API access...</div>';

            // Note: This will be blocked by CORS, but we can show the attempt
            resultDiv.innerHTML = `
                <div class="warning">
                    <h3>üåê Direct API Test</h3>
                    <p>Direct browser access to Paystack API is blocked by CORS (this is normal).</p>
                    <p>Our serverless functions handle the API calls with proper credentials.</p>
                    <p><strong>Your Paystack key environment:</strong> Test Mode</p>
                    <p><strong>Key prefix:</strong> sk_test_...</p>
                </div>
            `;
        }

        async function checkPaystackConfig() {
            const resultDiv = document.getElementById('advancedResults');
            resultDiv.innerHTML = '<div class="info">‚öôÔ∏è Checking Paystack configuration...</div>';

            try {
                // Test both debug and secure functions
                const [debugResp, secureResp] = await Promise.all([
                    fetch('/functions/v1/paystack-debug', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'check_key_health' })
                    }),
                    fetch('/functions/v1/paystack-secure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'initialize',
                            email: 'config@test.com',
                            amount: 50000,
                            currency: 'NGN'
                        })
                    })
                ]);

                const debugData = await debugResp.json();
                const secureData = await secureResp.json();

                resultDiv.innerHTML = `
                    <div class="info">
                        <h3>‚öôÔ∏è Configuration Status</h3>
                        
                        <h4>üîß Debug Function</h4>
                        <pre>${JSON.stringify(debugData, null, 2)}</pre>
                        
                        <h4>üîê Secure Function</h4>
                        <pre>${JSON.stringify(secureData, null, 2)}</pre>
                        
                        <div class="${debugData.success && secureData.success ? 'success' : 'warning'}">
                            <h4>üìä Summary</h4>
                            <p><strong>Debug Function:</strong> ${debugData.success ? '‚úÖ Working' : '‚ùå Issues'}</p>
                            <p><strong>Secure Function:</strong> ${secureData.success ? '‚úÖ Working' : '‚ùå Issues'}</p>
                            <p><strong>Both use same credentials:</strong> ${debugData.success && secureData.success ? '‚úÖ Yes' : '‚ö†Ô∏è Check logs'}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Configuration check failed: ${error.message}</div>`;
            }
        }

        // Auto-run credential test on page load
        window.addEventListener('load', () => {
            setTimeout(testCredentials, 1000);
        });
    </script>
</body>
</html>
