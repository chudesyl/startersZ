<!DOCTYPE html>
<html>
<head>
    <title>Direct Supabase Functions Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        .success { background: #f0f8f0; border-left: 4px solid #10b981; padding: 15px; margin: 10px 0; }
        .error { background: #fdf2f2; border-left: 4px solid #ef4444; padding: 15px; margin: 10px 0; }
        .info { background: #f0f4ff; border-left: 4px solid #3b82f6; padding: 15px; margin: 10px 0; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 5px; font-size: 14px; background: #3b82f6; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .url-test { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîß Direct Supabase Functions URL Test</h1>
            <p>Testing different URL patterns to find working Supabase functions.</p>
        </div>

        <div class="card">
            <h2>üéØ URL Pattern Tests</h2>
            <button onclick="testAllUrls()">Test All URL Patterns</button>
            <div id="urlResults"></div>
        </div>

        <div class="card">
            <h2>üí° Recommended Fix</h2>
            <div id="recommendedFix"></div>
        </div>
    </div>

    <script>
        async function testAllUrls() {
            const resultDiv = document.getElementById('urlResults');
            resultDiv.innerHTML = '<div class="info">üîÑ Testing various URL patterns...</div>';

            const baseUrl = 'https://oknnklksdiqaifhxaccs.supabase.co';
            const functionName = 'paystack-debug';
            
            const urlPatterns = [
                `/functions/v1/${functionName}`,
                `/rest/v1/functions/${functionName}`,
                `/edge-functions/${functionName}`,
                `/api/v1/functions/${functionName}`,
                `/functions/${functionName}`,
                `/edge/${functionName}`,
                `/v1/functions/${functionName}`
            ];

            let results = '<h3>üìä URL Test Results</h3>';
            let workingUrls = [];

            for (const pattern of urlPatterns) {
                try {
                    const fullUrl = `${baseUrl}${pattern}`;
                    const startTime = Date.now();
                    
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rbm5rbGtzZGlxYWlmaHhhY2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxOTA5MTQsImV4cCI6MjA2ODc2NjkxNH0.3X0OFCvuaEnf5BUxaCyYDSf1xE1uDBV4P0XBWjfy0IA'
                        },
                        body: JSON.stringify({ action: 'check_key_health' })
                    });

                    const duration = Date.now() - startTime;
                    const status = response.status;
                    
                    let responseText = '';
                    try {
                        responseText = await response.text();
                    } catch {}

                    const className = status === 404 ? 'error' : status < 400 ? 'success' : 'error';
                    
                    if (status !== 404) {
                        workingUrls.push({ pattern, status, response: responseText });
                    }

                    results += `
                        <div class="url-test">
                            <div class="${className}">
                                <p><strong>URL:</strong> <code>${pattern}</code></p>
                                <p><strong>Status:</strong> ${status} (${duration}ms)</p>
                                ${status !== 404 ? `
                                    <details>
                                        <summary>Response</summary>
                                        <pre>${responseText}</pre>
                                    </details>
                                ` : ''}
                            </div>
                        </div>
                    `;

                } catch (error) {
                    results += `
                        <div class="url-test">
                            <div class="error">
                                <p><strong>URL:</strong> <code>${pattern}</code></p>
                                <p><strong>Error:</strong> ${error.message}</p>
                            </div>
                        </div>
                    `;
                }
            }

            resultDiv.innerHTML = results;
            
            // Show recommended fix
            showRecommendedFix(workingUrls);
        }

        function showRecommendedFix(workingUrls) {
            const fixDiv = document.getElementById('recommendedFix');
            
            if (workingUrls.length === 0) {
                fixDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå No Working URLs Found</h3>
                        <p><strong>Issue:</strong> Supabase functions are not accessible through any standard URL pattern.</p>
                        
                        <h4>üõ†Ô∏è Required Actions:</h4>
                        <ol>
                            <li><strong>Deploy Functions:</strong> Functions need to be deployed to Supabase</li>
                            <li><strong>Check Environment Variables:</strong> Ensure all required env vars are set in Supabase</li>
                            <li><strong>Verify Configuration:</strong> Check Supabase project settings</li>
                        </ol>

                        <h4>üîß Manual Deployment Steps:</h4>
                        <pre>
# If you have Supabase CLI access:
supabase functions deploy paystack-debug
supabase functions deploy paystack-secure
supabase functions deploy payment-callback

# Set environment variables in Supabase dashboard:
PAYSTACK_SECRET_KEY_TEST=sk_test_0311ba51e34c9ab686b86850bd70294634d3e41f
PAYSTACK_SECRET_KEY=sk_test_0311ba51e34c9ab686b86850bd70294634d3e41f
                        </pre>

                        <div class="info">
                            <h4>üåê Alternative: Use Supabase Dashboard</h4>
                            <p>1. Go to <a href="https://supabase.com/dashboard/project/oknnklksdiqaifhxaccs" target="_blank">Supabase Dashboard</a></p>
                            <p>2. Navigate to Edge Functions</p>
                            <p>3. Deploy missing functions from the supabase/functions directory</p>
                            <p>4. Set environment variables in Project Settings ÔøΩÔøΩÔøΩ Environment Variables</p>
                        </div>
                    </div>
                `;
            } else {
                fixDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Found Working URLs!</h3>
                        <p><strong>Working URL Patterns:</strong></p>
                        ${workingUrls.map(url => `
                            <div class="info">
                                <p><code>${url.pattern}</code> - Status: ${url.status}</p>
                            </div>
                        `).join('')}
                        
                        <h4>üîß Next Steps:</h4>
                        <p>Update your application to use the working URL pattern(s) above.</p>
                    </div>
                `;
            }
        }

        // Test a simple public endpoint first
        async function testPublicEndpoint() {
            try {
                const response = await fetch('https://oknnklksdiqaifhxaccs.supabase.co/rest/v1/', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rbm5rbGtzZGlxYWlmaHhhY2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxOTA5MTQsImV4cCI6MjA2ODc2NjkxNH0.3X0OFCvuaEnf5BUxaCyYDSf1xE1uDBV4P0XBWjfy0IA'
                    }
                });
                
                console.log('‚úÖ Supabase REST API accessible:', response.status);
                return true;
            } catch (error) {
                console.error('‚ùå Supabase not accessible:', error);
                return false;
            }
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            testPublicEndpoint().then(accessible => {
                if (accessible) {
                    setTimeout(testAllUrls, 1000);
                } else {
                    document.getElementById('urlResults').innerHTML = `
                        <div class="error">
                            <h3>‚ùå Supabase Instance Not Accessible</h3>
                            <p>Cannot connect to the Supabase instance. Check your internet connection and Supabase URL.</p>
                        </div>
                    `;
                }
            });
        });
    </script>
</body>
</html>
